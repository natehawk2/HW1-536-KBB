---
title: "KW 1 KBB"
author: "Nathan Hawkins"
date: "9/14/2021"
output: html_document
---
```{r}
library(ggplot2)
library(bestglm)
library(corrplot)
library(scales)
```
# Introduction
In this analysis we are trying to help consumers understand what factors influence the price of their cars. In this analysis we are using data from Kelley Blue Books, a vehicle evaluation and automotive research company. The data contains 13 variables (Mileage, Make, Model, Trim, Type, Cylinder, Liter, Number of Doors, Cruise, Sound, Leather, and Price) including our response variable price. All of these variables, besides price and mileage, are factor variables. One issue that arises when looking at the data is that some of the factor variables are linear combination of other factors. An example of this is certain trims are only available for one type of model making it impossible to separate the effect of that specific trim and the model it is associated with. Another concern is some of the variables have upwards of 30 levels making it which might lead to inflated p-values when looking at the model.

#EDA

When looking at the effect mileage has on price it appears as though there might be different effects depending on the make of the car. We are using this interaction in our model. 

```{r Game-Effect, fig.cap="This graph shows the prmice of cars as a function of how many miles they have and what make the car is. The x axis is miles and the y axis is price is USD",fig.align='center', echo=FALSE, message=FALSE}


kbb %>% 
  ggplot(aes(x = Mileage, y = Price, color = Make)) +
  geom_point(alpha = 0.5) +
  theme_minimal() +
    labs(
    title = "Scatter Plot of Price as a Function of Mileage and Make",
    caption = "Data taken from the Kelley Blue Book",
    color = "Make"
  ) +
  # geom_smooth(data = (kbb %>% filter(Make == "Buick")), method = "lm", se = FALSE) +
  geom_smooth(data = (kbb %>% filter(Make == "Cadillac")), method = "lm", se = FALSE) +
  # geom_smooth(data = (kbb %>% filter(Make == "Chevrolet")), method = "lm", se = FALSE) +
  # geom_smooth(data = (kbb %>% filter(Make == "Pontiac")), method = "lm", se = FALSE) +
  # geom_smooth(data = (kbb %>% filter(Make == "SAAB")), method = "lm", se = FALSE) +
  geom_smooth(data = (kbb %>% filter(Make == "Saturn")), method = "lm", se = FALSE) +
  xlab("Mileage") + 
  ylab("Price") +
  scale_y_continuous(labels = label_number(suffix = "K", scale = 1e-3)) + 
  scale_x_continuous(labels = label_number(suffix = "K", scale = 1e-3)) +
  theme(
    panel.grid = element_blank()
  )
```  



There also appears to be a difference between cars with leather and cars without and cars with upgraded sound system and those without

```{r echo = FALSE}
kbb <- read.csv("KBB.csv", stringsAsFactors = TRUE)

# ggplot(data = kbb, mapping = aes(x = Mileage, y = Price)) + 
#   geom_point() 
# 
# ggplot(data = kbb, mapping = aes(x = as.factor(Doors), y = Price)) + 
#   geom_boxplot() 
# 
# ggplot(data = kbb, mapping = aes(x = as.factor(Cylinder), y = Price)) + 
#   geom_boxplot() 
# 
# ggplot(data = kbb, mapping = aes(x = as.factor(Make), y = Price)) + 
#   geom_boxplot() 
# 
# ggplot(data = kbb, mapping = aes(y = as.factor(Trim), x = Price)) + 
#   geom_boxplot() 
# 
# ggplot(data = kbb, mapping = aes(y = as.factor(Model), x = Price)) + 
  # geom_boxplot() 

par()

kbb %>% 
  mutate(Leather = case_when(
    Leather == 0 ~ "No Leather",
    TRUE ~ "Leather"
  )) %>% 
ggplot(mapping = aes(x = as.factor(Leather), y = Price, fill = as.factor(Leather))) + 
  geom_boxplot() +
  theme_minimal() +
  labs(
    x = "",
    y = "Price (USD)",
    title = "Boxplot Comparing Price of Leather and Non Leather",
    caption = "Data taken from the Kelley Blue Book",
    fill = ""
  ) +
  theme(
    legend.position = "None",
    panel.grid = element_blank(),
    axis.title.y = element_text(angle = 0)
  ) +
  scale_y_continuous(labels = label_number(suffix = "K", scale = 1e-3)) 

kbb %>% 
  mutate(Sound = case_when(
    Sound == 0 ~ "Regular",
    TRUE ~ "Upgraded"
  )) %>% 
ggplot(mapping = aes(x = as.factor(Sound), y = Price, fill = as.factor(Sound))) + 
  geom_boxplot() +
  theme_minimal() +
  labs(
    x = "",
    y = "Price (USD)",
    title = "Boxplot Comparing Price of Upgraded Sound and Regular",
    caption = "Data taken from the Kelley Blue Book",
    fill = ""
  ) +
  theme(
    legend.position = "None",
    panel.grid = element_blank(),
    axis.title.y = element_text(angle = 0)
  ) +
  scale_y_continuous(labels = label_number(suffix = "K", scale = 1e-3))

# ggplot(data = kbb, mapping = aes(x = as.factor(Cruise), y = Price)) + 
#   geom_boxplot()
```



```{r}
library(dplyr)


kbb$make_model_trim <- as.factor(paste0(kbb$Make, kbb$Model, kbb$Trim))

library(bestglm)
bestglm(kbb[,c(2:13,1)], IC = "AIC", method = "exhaustive")

model <- lm(Price ~  Mileage + Mileage:Make + Sound + Leather + make_model_trim , data = kbb)

AIC(model)
BIC(model)
rsq::rsq(model)
summary(model)
library(car)
vif(model)

sd(model$residuals)
sd(kbb$Price)

length(model$coefficients)

library(ggplot2)
ggplot(data = kbb, mapping = aes(x = Mileage, y = Price, )) + 
  geom_point()
```

```{r}
samp <- sample(1:nrow(kbb), round(nrow(kbb)*.9, 0), replace = FALSE)
train <- kbb[samp,]
test <- kbb[-samp,]

train.model <- lm(Price ~  Mileage + Mileage:Make + Sound + Leather + make_model_trim , data = train)

predictions <- predict.lm(train.model, test)

(test$Price - predictions)^2
```



```{r}

summary(model)
library(multcomp)
library(car)
car::vif(model)
a <- matrix(rep(0, 66), nrow = 1)
a[45] <- 1
dim(a)
library(MASS)
dim(vcov(model))
glht_a <- glht(model, a)
summary(glht_a)
```


```{r include = FALSE}
kbb$Cylinder <- as.factor(kbb$Cylinder)
model <- Price~.
fit <- lm(model, kbb)
test <- ols_step_all_possible(fit)
View(test)

```


# Assumptions

Linearity assumption.
```{r}
avPlots(model)
```

# Normality

They look very normal.
```{r}
hist(model$residuals)
qqPlot(model)
```
# Equal Variance

```{r}
plot(model$fitted.values, model$residuals)
plot(model)
```



```{r}
library(magrittr)
mydataset <- kbb
n <- round(nrow(mydataset),0)
n.cv <- 100 #Number of CV studies to run
n.test <-  round(nrow(mydataset)*0.1,0)
rpmse <- rep(x=NA, times=n.cv)
bias <- rep(x=NA, times=n.cv)
wid <- rep(x=NA, times=n.cv)
cvg <- rep(x=NA, times=n.cv)
for(cv in 1:n.cv){
  ## Select test observations
  test.obs <- sample(x=1:n, size=n.test)
  
  ## Split into test and training sets
  test.set <- mydataset[test.obs,]
  train.set <- mydataset[-test.obs,]
  
  ## Fit a lm() using the training data
  train.lm <- lm(Price ~  Mileage + Mileage:Make + Sound + Leather + make_model_trim , data = train.set)
  
  ## Generate predictions for the test set
  my.preds <- predict.lm(train.lm, newdata=test.set, interval="prediction")
  
  ## Calculate bias
  bias[cv] <- mean(my.preds[,'fit']-test.set[['Price']])
  
  ## Calculate RPMSE
  rpmse[cv] <- (test.set[['Price']]-my.preds[,'fit'])^2 %>% mean() %>% sqrt()
  
  ## Calculate Coverage
  cvg[cv] <- ((test.set[['Price']] > my.preds[,'lwr']) & (test.set[['Price']] < my.preds[,'upr'])) %>% mean()
  
  ## Calculate Width
  wid[cv] <- (my.preds[,'upr'] - my.preds[,'lwr']) %>% mean()
  
}
hist(rpmse)
hist(bias)
mean(bias)
hist(cvg)
hist(wid)
sd(kbb$Price)
```

